name: Akamai Cache Purge

on:
  workflow_dispatch:
    inputs:
      url:
        description: "URL to purge"
        required: true
      network:
        description: "staging or production"
        required: true
        default: "staging"

jobs:
  purge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests
          python -m pip install edgegrid-python   # <<--- THIS IS CRITICAL

      - name: Purge Akamai Cache
        run: |
          python purge_akamai.py
        env:
          AKAMAI_CLIENT_TOKEN: ${{ secrets.AKAMAI_CLIENT_TOKEN }}
          AKAMAI_CLIENT_SECRET: ${{ secrets.AKAMAI_CLIENT_SECRET }}
          AKAMAI_ACCESS_TOKEN: ${{ secrets.AKAMAI_ACCESS_TOKEN }}
          AKAMAI_HOST: ${{ secrets.AKAMAI_HOST }}
      #  run: |
          python << 'EOF'
          import os
          import requests
          from edgegrid import EdgeGridAuth

          url = "${{ github.event.inputs.url }}"
          network = "${{ github.event.inputs.network }}"

          session = requests.Session()
          session.auth = EdgeGridAuth(
              client_token=os.environ["AKAMAI_CLIENT_TOKEN"],
              client_secret=os.environ["AKAMAI_CLIENT_SECRET"],
              access_token=os.environ["AKAMAI_ACCESS_TOKEN"]
          )

          endpoint = f"https://{os.environ['AKAMAI_HOST']}/ccu/v3/invalidate/url"
          payload = {
              "objects": [url],
              "network": network
          }

          r = session.post(endpoint, json=payload)
          print("Status:", r.status_code)
          print(r.text)

          if r.status_code not in (201, 202):
              raise SystemExit("❌ Purge failed")

          print("✅ Purge request accepted")
          EOF

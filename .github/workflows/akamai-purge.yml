name: Akamai Cache Purge (No Python)

on:
  workflow_dispatch:
    inputs:
      purge_type:
        description: "Purge type"
        required: true
        type: choice
        options:
          - url
          - cpcode
          - tag

      purge_objects:
        description: "Comma-separated URLs / CPCodes / Tags"
        required: true

      network:
        description: "Akamai network"
        required: true
        default: production
        type: choice
        options:
          - staging
          - production

jobs:
  purge:
    runs-on: ubuntu-latest

    steps:
      - name: Install Akamai CLI (Go binary)
        run: |
          curl -s https://akamai.github.io/cli/install.sh | bash
          akamai install purge

      - name: Configure Akamai credentials
        run: |
          mkdir -p ~/.akamai
          cat <<EOF > ~/.akamai/credentials
          [default]
          client_token = ${{ secrets.AKAMAI_CLIENT_TOKEN }}
          client_secret = ${{ secrets.AKAMAI_CLIENT_SECRET }}
          access_token = ${{ secrets.AKAMAI_ACCESS_TOKEN }}
          host = ${{ secrets.AKAMAI_HOST }}
          EOF

      - name: Run Akamai Purge
        run: |
          OBJECTS=$(echo "${{ github.event.inputs.purge_objects }}" | tr ',' ' ')
          TYPE="${{ github.event.inputs.purge_type }}"
          NET="${{ github.event.inputs.network }}"

          if [ "$TYPE" = "url" ]; then
            akamai purge invalidate --network $NET --urls $OBJECTS
          elif [ "$TYPE" = "cpcode" ]; then
            akamai purge invalidate --network $NET --cpcode $OBJECTS
          elif [ "$TYPE" = "tag" ]; then
            akamai purge invalidate --network $NET --tags $OBJECTS
          fi

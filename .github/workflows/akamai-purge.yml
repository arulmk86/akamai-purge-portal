name: Akamai Cache Purge

on:
  workflow_dispatch:
    inputs:
      url:
        description: "URL to purge"
        required: true
      network:
        description: "Akamai network"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

jobs:
  purge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ðŸ”‘ THIS IS THE MOST IMPORTANT STEP
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify Python
        run: |
          python --version
          pip --version

      - name: Install Akamai EdgeGrid SDK
        run: |
          python -m pip install --upgrade pip
          pip install requests akamai-edgegrid-python

      - name: Show user input
        run: |
          echo "URL=${{ github.event.inputs.url }}"
          echo "NETWORK=${{ github.event.inputs.network }}"

      - name: Purge Akamai Cache
        env:
          AKAMAI_CLIENT_TOKEN: ${{ secrets.AKAMAI_CLIENT_TOKEN }}
          AKAMAI_CLIENT_SECRET: ${{ secrets.AKAMAI_CLIENT_SECRET }}
          AKAMAI_ACCESS_TOKEN: ${{ secrets.AKAMAI_ACCESS_TOKEN }}
          AKAMAI_HOST: ${{ secrets.AKAMAI_HOST }}
        run: |
          python << 'EOF'
          import requests
          from akamai.edgegrid import EdgeGridAuth
          import os

          url_to_purge = "${{ github.event.inputs.url }}"
          network = "${{ github.event.inputs.network }}"

          base_url = f"https://{os.environ['AKAMAI_HOST']}"
          endpoint = "/ccu/v3/invalidate/url"

          session = requests.Session()
          session.auth = EdgeGridAuth(
              client_token=os.environ["AKAMAI_CLIENT_TOKEN"],
              client_secret=os.environ["AKAMAI_CLIENT_SECRET"],
              access_token=os.environ["AKAMAI_ACCESS_TOKEN"],
          )

          payload = {
              "objects": [url_to_purge],
              "network": network
          }

          resp = session.post(base_url + endpoint, json=payload)

          print("Status:", resp.status_code)
          print(resp.text)

          if resp.status_code not in (201, 202):
              raise SystemExit("âŒ Purge failed")

          print("âœ… Purge request accepted")
          EOF

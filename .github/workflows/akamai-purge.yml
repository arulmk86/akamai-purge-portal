name: Akamai Cache Purge

on:
  workflow_dispatch:
    inputs:
      network:
        description: "Select Akamai network"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

      urls:
        description: "URLs to purge (comma separated)"
        required: true
        default: "https://www.example.com/test.txt"

jobs:
  purge:
    runs-on: ubuntu-latest

    steps:
      - name: Show user input
        run: |
          echo "Network : ${{ github.event.inputs.network }}"
          echo "URLs    : ${{ github.event.inputs.urls }}"

      - name: Install Akamai EdgeGrid library
        run: |
          python3 -m pip install --upgrade pip
          pip install requests akamai-edgegrid==1.3.1

      - name: Purge Akamai Cache
        env:
          AKAMAI_CLIENT_TOKEN: ${{ secrets.AKAMAI_CLIENT_TOKEN }}
          AKAMAI_CLIENT_SECRET: ${{ secrets.AKAMAI_CLIENT_SECRET }}
          AKAMAI_ACCESS_TOKEN: ${{ secrets.AKAMAI_ACCESS_TOKEN }}
          AKAMAI_HOST: ${{ secrets.AKAMAI_HOST }}
          NETWORK: ${{ github.event.inputs.network }}
          URLS: ${{ github.event.inputs.urls }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import requests
          from akamai.edgegrid import EdgeGridAuth

          client_token = os.environ["AKAMAI_CLIENT_TOKEN"]
          client_secret = os.environ["AKAMAI_CLIENT_SECRET"]
          access_token = os.environ["AKAMAI_ACCESS_TOKEN"]
          host = os.environ["AKAMAI_HOST"]
          network = os.environ["NETWORK"]
          urls = [u.strip() for u in os.environ["URLS"].split(",")]

          endpoint = f"https://{host}/ccu/v3/invalidate/url/{network}"

          session = requests.Session()
          session.auth = EdgeGridAuth(
              client_token=client_token,
              client_secret=client_secret,
              access_token=access_token
          )

          payload = { "objects": urls }

          print("Endpoint:", endpoint)
          print("Payload:", json.dumps(payload, indent=2))

          response = session.post(endpoint, json=payload)

          print("Status:", response.status_code)
          print("Response:", response.text)

          if response.status_code not in [201, 202]:
              raise Exception("❌ Akamai purge failed")
          else:
              print("✅ Akamai purge accepted")
          EOF
